var fs = require('fs');
var util = require('util');
var EventEmitter = require("events").EventEmitter;
var _ = require('underscore');
var http = require('https');
var qs = require('querystring');


function MusicManager(){
	var self = this;
	var server_options = {};
	var list = {};

	var db;

	this.folder = "./data/files/";

	var status = 'unloaded';
	var downloadBlock = false;
};

util.inherits(MusicManager, EventEmitter);

MusicManager.prototype.init = function(player_opts, server_options, db){
	var self = this;
	this.server_options = server_options;
	this.player_opts = player_opts;	
	
	this.db = db;
	this.db.transaction(function (tx) {
	  tx.executeSql('CREATE TABLE IF NOT EXISTS musicas_temp (audioid, name, artist, band, album, mood_velocity, mood_happy, path, playlist, type, date_start, date_end, hour_start, hour_end, weekdays, min_interval)',[],function(){
		tx.executeSql('DELETE FROM musicas_temp',function(){
			// complete
		},null, self.SQLError);
	  }, self.SQLError);
	  tx.executeSql('CREATE TABLE IF NOT EXISTS musicas (audioid, name, artist, band, album, mood_velocity, mood_happy, path, playlist, type, date_start, date_end, hour_start, hour_end, weekdays, min_interval)',[],null, self.SQLError);
	  
	  // tx.executeSql('SELECT name FROM mydb.sqlite_master WHERE type="table"', [], function (tx, results) {
	  //   var len = results.rows.length, i;
	  //   for (i = 0; i < len; i++) {	    	
	  //   	var res = results.rows.item(i);	    	
	  //     	console.log(res);
	  //   }
	  // }, self.SQLError);
	});
	self.loadList();
}

MusicManager.prototype.SQLError = function(){
	console.error( arguments );
	//throw new Error(arguments.join(','));
}

/**
*     List Manager
*
*/

MusicManager.prototype.saveList = function( data ){
	var self = this;

	this.db.transaction(function (tx) {
		_.each( self.list.audios, function( val, i ){
			var mus = val;
			console.log(val);
			var keys = _.keys(val);
			var values = _.values(val);
			tx.executeSql('INSERT INTO musicas_temp (' + keys.join(', ') +') VALUES ("' + values.join('", "') +'")',[],null,self.SQLError);
		});
	});

	var txt = JSON.stringify(this.list);
	this.emit('savelist', txt);
};

MusicManager.prototype.loadList = function( ){
	//( server_options && ( _.extend( this.server_options, server_options )));

	var self = this;
	var res_data = "";
	// LOAD THE DATA

	var options = {headers: {}};
	var data = {psw:"asd"};

	options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
	data = qs.stringify({psw:this.player_opts.password});
	options.headers['Content-Length'] = data.length;

	_.extend( options, this.server_options, {
	  path: this.server_options.path + '/player/' +  this.player_opts.name,
	  method: 'POST'
	});

	//console.log( options );
	
	var req = http.request( options, function(res){
		res.setEncoding('utf8');
		res.on('data', function (chunk) {
			res_data += chunk;
			this.emit('loadlist-data', res_data, chunk);			
		});

		res.on('end', function() {
			console.log(res_data);
			try{				
				self.list = JSON.parse(res_data).data;	
				self.saveList();			
				self.emit('loadlist-complete', JSON.parse(res_data));
			}catch(err) {
			    console.log( "Erro ao importar lista do servidor", err.message );
			}
		});

	});

	req.on('error', function(e) {
		this.emit('loadlist-error', res_data);
		//console.log('problem with request: ' + e.message);
	});

	req.write(data);
	req.end();
}

MusicManager.prototype.verifyList = function( list ){
	var self = this;
	list || (list = self.list.audios);
	
	var ret = {
		founded: [],
		notfounded: []
	};

	_.each(list, function( music ){
		var filename = music.path.split('/').pop();
		if(fs.existsSync( "./data/files/" + filename )){
			ret.founded.push(music);
		}else{
			ret.notfounded.push(music);
		}; 
	});

	return ret;
}

MusicManager.prototype.comparieLists = function(callback){
	var self = this;
	this.db.transaction(function (tx) {
	  tx.executeSql('SELECT t1.* FROM musicas_temp t1 LEFT JOIN musicas t2 ON t2.audioid = t1.audioid WHERE t2.audioid IS NULL', [], function (tx, results) {
	  	var ret = [];
	    var len = results.rows.length, i;
	    for (i = 0; i < len; i++) {	    	
	    	var mus = results.rows.item(i);	    	
	    	mus.file = (mus.path).split('/').pop();
	      	ret.push(mus);
	      	console.log(mus);
	    }
	    if(callback)callback(ret);
	  }, self.SQLError);
	});
}

// Busca os arquivos de áudio local
/* provisoriamente usada como playlist */
MusicManager.prototype.localList = function(callback){
	var self = this;
	// Query out the data
	this.db.transaction(function (tx) {
	  tx.executeSql('SELECT * FROM musicas', [], function (tx, results) {
	  	var ret = [];
	    var len = results.rows.length, i;
	    for (i = 0; i < len; i++) {	    	
	    	var mus = results.rows.item(i);	    	
	    	mus.file = (mus.path).split('/').pop();
	      	ret.push(mus);
	      	console.log(mus);
	    }
	    if(callback)callback(ret);
	  }, self.SQLError);
	});
}

MusicManager.prototype.tempList = function(callback){
	var self = this;
	// Query out the data
	this.db.transaction(function (tx) {
	  tx.executeSql('SELECT * FROM musicas_temp', [], function (tx, results) {
	  	var ret = [];
	    var len = results.rows.length, i;
	    for (i = 0; i < len; i++) {	    	
	    	var mus = results.rows.item(i);	    	
	    	mus.file = (mus.path).split('/').pop();
	      	ret.push(mus);
	      	console.log(mus);
	    }
	    if(callback)callback(ret);
	  }, self.SQLError);
	});
}

MusicManager.prototype.updateList = function(callback){
	(callback || (callback = function(){}));
	var self = this;
	self.db.transaction(function (tx) {
		//tx.executeSql('TRUNCATE TABLE musicas');
		tx.executeSql('DELETE FROM musicas',[],function(){
			tx.executeSql('INSERT INTO musicas SELECT * FROM musicas_temp', [], function (tx, results) {
				if(callback){callback(results);}
			}, self.SQLError);

		});
	});
}

MusicManager.prototype.resetLists = function(){
	var self = this;
	this.db.transaction(function (tx) {
		tx.executeSql('DELETE FROM musicas_temp',function(){
				// complete
			},null, self.SQLError);
		tx.executeSql('DELETE FROM musicas',function(){
				// complete
			},null, self.SQLError);	
	});
	_.each(fs.readdirSync("./data/files/"), function( music ){
		console.log(music);
		if(fs.existsSync( "./data/files/" + music )){
			fs.unlink( "./data/files/" + music );
		}; 
	});
}

/**
*     Musics Manager
*
*/

MusicManager.prototype.downloadMusics = function( list ){
	var self = this;
	list || (list = self.verifyList().notfounded);

	if(list.length == 0){ 
		self.comparieLists(function(list){
			self.emit('loadmusic-allcomplete');
			if( list.length == 0 ){
				console.log("Todas as musicas estao baixadas e já atualizadas");				
			}else{
				console.log("Todas as musicas estao baixadas e tem atualização");
				self.emit('loadmusic-hasUpdate');
			}
		});
		self.emit('loadmusic-allcomplete'); 
		return true; 
	}

	var next = list.pop();
	var filename = next.path.split('/').pop();

	var so = this.server_options;

	var file_url = so.protocol + "//" + so.hostname + so.path + "/" + next.path;
	var file_uri = this.folder + filename;

	if(!fs.existsSync( file_uri )){
		var file = fs.createWriteStream( file_uri );

		var options = {
		    path: file_url
		};
		_.extend( options, this.server_options);

		http.get( file_url , function(res) {
			self.emit('loadmusic-start', next);
			console.log(file_url + ' downling');
		    res.on('data', function(data) {
		            file.write(data);
		        }).on('end', function() {
		            file.end();
					self.emit('loadmusic-complete', next);
		            self.downloadMusics(list);
		            console.log(file_url + ' downloaded');
		        });
		    });
	}else{
		console.log(filename + ' exists ');
		this.downloadMusics(list);
	}
}



module.exports = new MusicManager();

