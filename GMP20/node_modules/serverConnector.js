var fs = require('fs');
var util = require('util');
var EventEmitter = require("events").EventEmitter;
var _ = require('underscore');
var http = require('https');
var qs = require('querystring');


function ServerConnector(){	
	var player_opts;
	var server_options;
	var list;
};

util.inherits(ServerConnector, EventEmitter);

ServerConnector.prototype.init = function(player_opts, server_options){
	this.player_opts = player_opts;
	this.server_options = server_options;
}

ServerConnector.prototype.loadList = function( ){
	//( server_options && ( _.extend( this.server_options, server_options )));
	
	var self = this;
	var res_data = "";
	// LOAD THE DATA

	var options = {headers: {}};
	var data = {psw:"asd"};

	options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
	data = qs.stringify({psw:this.player_opts.password});
	options.headers['Content-Length'] = data.length;

	_.extend( options, this.server_options, {
	  path: this.server_options.path + '/player/' +  this.player_opts.name,
	  method: 'POST'
	});
	if(true){
		var req = http.request( options, function(res){
			res.setEncoding('utf8');
			res.on('data', function (chunk) {
				res_data += chunk;
				this.emit('loadlist-data', res_data, chunk);
			});
			
			res.on('end', function() {
				try{				
					var list = JSON.parse(res_data).data;
					self.emit('loadedlist', res_data);
				}catch(err) {
					console.log( "Erro ao importar lista do servidor", err.message );
				}
			});

		});
		console.log(req);
		req.on('error', function(e) {
			this.emit('loadlist-error', res_data);
			console.log('problem with request: ' + e.message);
		});
		
		req.write(data);
		req.end();
	} else {
		res_data = 	'{"result":"success",'+
			'"data":{'+
			'"player":"teste-3","client":"Teste Misto","audios":['+
			' {"audioid":"1","name":"reprovação total","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"20141231","hour_start":"0","hour_end":"0","weekdays":"0000000","min_interval":"0"}'+// 
			',{"audioid":"2","name":"reprovada por data e hora","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"20141231","hour_start":"0","hour_end":"0","weekdays":"1111111","min_interval":"0"}'+//
			',{"audioid":"3","name":"reprovada por hora","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"0","weekdays":"1111111","min_interval":"0"}'+//
			',{"audioid":"4","name":"reprovada por data","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"20141231","hour_start":"0","hour_end":"24","weekdays":"1111111","min_interval":"0"}'+// 			
			//',{"audioid":"6","name":"aprovação total 2","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1111111","min_interval":"0"}'+// 
			//',{"audioid":"6","name":"aprovação total","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1111111","min_interval":"0"}'+// 
			',{"audioid":"7","name":"reprovação por dia da semana","artist":"Luiz Bonfa","band":"","album":"Meu Querido Violao","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-yargo","type":"normal","date_start":"20141231","date_end":"20150831","hour_start":"0","hour_end":"24","weekdays":"0000000","min_interval":"0"}],'+
			'"token":1545227117}}';
			
		//res_data = 	'{"result":"success","data":{"player":"teste-3","client":"Teste Misto","audios":[{"audioid":"81","name":"Caia na risada","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517234_1962886831.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"93","name":"Caveira","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517825_1075522392.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"92","name":"Dia tão cinzento","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517800_955378500.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"91","name":"Esse aí","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517718_169308859.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"80","name":"Padrada","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517217_97837251.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"88","name":"Saiba ficar quieto","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517494_103980556.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"87","name":"Se eu for","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517423_1393306384.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"86","name":"Uva de caminhão","artist":"Romulo Fróes","band":"","album":"2a. Sessão: Saiba Ficar Quieto","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425517407_758130479.ogg","playlist":"playlist-misto","type":"normal","date_start":"20141231","date_end":"22001231","hour_start":"0","hour_end":"24","weekdays":"1011101","min_interval":"0"},{"audioid":"97","name":"Aguas de Março","artist":"Orquestra Brasileira de Musica Jamaicana","band":"","album":"Skabrazooka","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425950733_379052550.ogg","playlist":"playlist-nula","type":"normal","date_start":"20141005","date_end":"20151005","hour_start":"0","hour_end":"24","weekdays":"0000001","min_interval":"0"},{"audioid":"96","name":"Aguas Dub","artist":"Orquestra Brasileira de Musica Jamaicana","band":"","album":"Skabrazooka","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425950711_1142869431.ogg","playlist":"playlist-nula","type":"normal","date_start":"20141005","date_end":"20151005","hour_start":"0","hour_end":"24","weekdays":"0000001","min_interval":"0"},{"audioid":"95","name":"Mosaico","artist":"Luiz Bonfa","band":"","album":"Meu Querido Violao","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425751268_1630733310.ogg","playlist":"playlist-yargo","type":"normal","date_start":"20141231","date_end":"20151231","hour_start":"12","hour_end":"24","weekdays":"1111111","min_interval":"0"},{"audioid":"94","name":"Paisagem Amazonica","artist":"Luiz Bonfa","band":"","album":"Meu Querido Violao","mood_velocity":"50","mood_happy":"50","path":".\/uploads\/audios\/1425751247_1090017465.ogg","playlist":"playlist-yargo","type":"normal","date_start":"20141231","date_end":"20151231","hour_start":"12","hour_end":"24","weekdays":"1111111","min_interval":"0"}],"token":276083551}}';
		
		console.log(res_data);
		setTimeout(function(){
			self.emit('loadedlist', res_data);
			}, 1000);
	}
}

ServerConnector.prototype.loadOrders = function( ){	
	var orders = 	'{'+
							'"orders":	['+
										/*/'{'+
											'"audioid":0, '+
											'"type":"reset-lists"'+
										'}, '+/*/
										'{'+
											'"audioid":1, '+
											'"type":"play-special", '+
											'"name":"Vinheta de Carnaval", '+
											'"description":"Portela nota 10", '+
											'"path":"path/to/vinheta.ogg", '+
											'"date_start":"20150120", '+       //a data é nesse formato por que o SQLLite não dá suporte a comparação de datas
											'"date_end":"20150228", '+         //a data é nesse formato por que o SQLLite não dá suporte a comparação de datas
											'"hour_start":"19:46:08", '+
											'"repeat":"daily"'+
										'},'+
										'{'+
											'"audioid":2, '+
											'"type":"update-list"'+
										'}, '+
										'{'+
											'"audioid":3, '+
											'"type":"nothing"'+
										'} '+
									'], '+
							'"token":"16061986"'+
					'}';
	console.log('Token = '+orders.token);
	
	return orders;
}


module.exports = new ServerConnector();

