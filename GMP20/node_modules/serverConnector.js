var fs = require('fs');
var util = require('util');
var EventEmitter = require("events").EventEmitter;
var _ = require('underscore');
var http = require('https');
var qs = require('querystring');


function ServerConnector(){	
	var player_opts;
	var server_options;
	var list;
};

util.inherits(ServerConnector, EventEmitter);

ServerConnector.prototype.init = function(player_opts, server_options){
	this.player_opts = player_opts;
	this.server_options = server_options;
}

ServerConnector.prototype.loadList = function( ){
	//( server_options && ( _.extend( this.server_options, server_options )));
	
	var self = this;
	var res_data = "";
	// LOAD THE DATA

	var options = {headers: {}};
	var data = {psw:"asd"};

	options.headers['Content-Type'] = 'application/x-www-form-urlencoded';
	data = qs.stringify({psw:this.player_opts.password});
	options.headers['Content-Length'] = data.length;

	_.extend( options, this.server_options, {
	  path: this.server_options.path + '/player/' +  this.player_opts.name,
	  method: 'POST'
	});

	var req = http.request( options, function(res){
		res.setEncoding('utf8');
		res.on('data', function (chunk) {
			res_data += chunk;
			this.emit('loadlist-data', res_data, chunk);
		});
		
		res.on('end', function() {
			try{				
				var list = JSON.parse(res_data).data;
				console.log(list);
				console.log("-------------------------------------------------");
				self.emit('loadedlist', res_data);
			}catch(err) {
			    console.log( "Erro ao importar lista do servidor", err.message );
			}
		});

	});

	req.on('error', function(e) {
		this.emit('loadlist-error', res_data);
		console.log('problem with request: ' + e.message);
	});
	
	req.write(data);
	req.end();
	
}

ServerConnector.prototype.loadOrders = function( ){	
	var orders = 	'{'+
							'"orders":	['+
										/*/'{'+
											'"audioid":0, '+
											'"type":"reset-lists"'+
										'}, '+/*/
										'{'+
											'"audioid":1, '+
											'"type":"play-special", '+
											'"name":"Vinheta de Carnaval", '+
											'"description":"Portela nota 10", '+
											'"path":"path/to/vinheta.ogg", '+
											'"date_start":"20150120", '+       //a data é nesse formato por que o SQLLite não dá suporte a comparação de datas
											'"date_end":"20150228", '+         //a data é nesse formato por que o SQLLite não dá suporte a comparação de datas
											'"hour_start":"19:46:08", '+
											'"repeat":"daily"'+
										'},'+
										'{'+
											'"audioid":2, '+
											'"type":"update-list"'+
										'}, '+
										'{'+
											'"audioid":3, '+
											'"type":"nothing"'+
										'} '+
									'], '+
							'"token":"16061986"'+
					'}';
	console.log('Token = '+orders.token);
	
	return orders;
}


module.exports = new ServerConnector();

