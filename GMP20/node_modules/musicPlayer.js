//musicPlayer

var fs = require('fs');
var util = require('util');
var EventEmitter = require("events").EventEmitter;

var _ = require('underscore');
var qs = require('querystring');


function Channel( audio, crossTime, extra ){
	var self = this;
	this.extra = extra;
	
	this.audio = audio;
	this.crossTime = crossTime;

	if(!this.extra){
		this.audio.onended 		= function(){ console.log( "musica terminada"); self.emit( 'musicEnded', self ); };
		this.audio.ontimeupdate = function(){ 
			var endTime 	= Math.max( self.audio.duration - ( self.crossTime / 1000 ), ( self.crossTime / 1000 ) );
			var percTime 	= ( self.audio.currentTime / endTime );
			
			self.emit( 
				'musicPlaying',
				percTime,
				self.audio.currentTime,
				endTime
			);
			if( percTime >= 1 ){
				self.emit( 
					'musicEnded',
					percTime,
					self.audio.currentTime,
					endTime 
				);
			}
		};
	} else {
		this.audio.onended 		= function(){ console.log( "extra terminado"); self.emit( 'extraEnded', self ); };
		this.audio.ontimeupdate = function(){ 
			var endTime 	= Math.max( self.audio.duration - ( self.crossTime / 1000 ), ( self.crossTime / 1000 ) );
			var percTime 	= ( self.audio.currentTime / endTime );
			
			self.emit( 
				'extraPlaying',
				percTime,
				self.audio.currentTime,
				endTime
			);
			if( percTime >= 1 ){
				self.emit( 
					'extraEnded',
					percTime,
					self.audio.currentTime,
					endTime 
				);
			}
		};
	}

	this._fading;
}

util.inherits(Channel, EventEmitter);

Channel.prototype.pause = function(){ this.audio.pause(); };
Channel.prototype.resume = function(){ this.audio.play(); };
Channel.prototype.play  = function( src ){ 
	this.audio.src = "./data/files/" + src + "?nocache=" + ( new Date() ).getTime();
	this.audio.play();
	if(!this.extra){
		this.emit("musicStart", this, src);
	} else {
		this.emit("extraStart", this, src);
	}

	return this;
};
Channel.prototype.resume = function (){ this.audio.play(); return this; }
Channel.prototype.stopFade = function( ){ if( this._fading ){ clearInterval(this._fading); }; return this; };
Channel.prototype.fadeDown = function( isExtra ){ this._startFade( -0.1 , 0, isExtra );  };
Channel.prototype.fadeIn   = function( isExtra ){ this._startFade(  0.1 , 1, isExtra ); };

Channel.prototype.volume = function( val ){ if(val !== undefined ){ this.audio.volume = Math.round( Math.max( Math.min( val, 1 ), 0 ) * 10 ) / 10 ; return this; }; return this.audio.volume; };
Channel.prototype._startFade = function( step, limit, isExtra ){
	var self = this;
	this.stopFade();
	var cross = (isExtra)? 500 : self.crossTime / 10;
	this._fading = setInterval( function(){ self._fade(  step , limit ); }, cross );
	return this; 
}
Channel.prototype._fade = function( step, limit, callback ){ 
	if( ( Math.round( this.volume() * 1000 ) / 1000 ) == limit ){ this.volume( limit ); this.stopFade(); if(callback){ callback(this); }; return; }
	this.audio.volume += step;
}

/* */

function MusicPlayer( baseElement ){

	var self = this;
	var base;
	var status = 'init';
	this.channel = 0;
	var base = baseElement;
	this.currentMusic;
	this.currentChannel;
	
	var tracer = 0;

	this.pos = 0;

	var channel1 = new Channel( base.getElementById("audio1"), 10000, false );
	channel1.on( 'musicEnded', function(){ if( self.currentChannel == self.channels[0] ) self.askForNextMusic();} );
	channel1.on( 'musicStart', function(){ self.emit("musicStart", self.channel1, self.currentMusic);} );
	channel1.on( 'musicPlaying', function(pos, current, total){ if( self.currentChannel == self.channels[0] ) self.emit("musicPlaying", pos, current, total);} );
	
	var channel2 = new Channel( base.getElementById("audio2"), 10000, false );
	channel2.on( 'musicEnded', function(){ if( self.currentChannel == self.channels[1] ) self.askForNextMusic();} );
	channel2.on( 'musicStart', function(){ self.emit("musicStart", self.channel2, self.currentMusic);} );
	channel2.on( 'musicPlaying', function(pos, current, total){ if( self.currentChannel == self.channels[1] ) self.emit("musicPlaying", pos, current, total);} );
	
	var channel3 = new Channel( base.getElementById("audio3"), 10000 , true );
	channel3.on( 'extraEnded', function(){ self.status = self.currentChannel.audio.id; self.currentChannel.volume(0).fadeIn( true ); } );
	channel3.on( 'extraStart', function(){ self.status = "extra"; } );
	channel3.on( 'extraPlaying', function(){  } );

	this.channels = [ channel1, channel2, channel3 ];
};

util.inherits(MusicPlayer, EventEmitter);

MusicPlayer.prototype.init = function(){
	var self = this;
	self.status = "stopped";
}
MusicPlayer.prototype.askForNextMusic = function(force){
	//if(!force)return;
	this.emit('next-music');
}
MusicPlayer.prototype.play = function(music){
	//if(!force)return;
	if(this.status=="stopped") {
		this.emit('next-music');
	}else if( this.status=="paused" ){
		this.status="playing";
		this.emit('change-status',this.status);
		this.currentChannel.resume();
	}else{
		this.status="paused";
		this.emit('change-status',this.status);		
		this.currentChannel.pause();
	}
}
MusicPlayer.prototype.getStatus = function(){
	return this.status;
}
MusicPlayer.prototype.nextMusic = function(music){
	//if(!force)return;	
	if(!music){
		this.emit('log', "Não há musicas na lista customizada. Por favor atualize sua playlist.");
	} else {
		this.status="playing";
		this.emit('change-status',this.status);		
		this.currentMusic = music;
		console.log(music);
		if( this.currentChannel ){ this.currentChannel.fadeDown( false ); status = "fade"; }
		this.swapChannel().volume(0).play( this.currentMusic.file ).fadeIn( false );
	}
}

MusicPlayer.prototype.playChamada = function (extra){
	var self = this;
	
	setTimeout(function(){
		self.channels[2].volume(1).play(extra.file);
	}, 5000);
	
	this.channels[0].fadeDown( true );
	this.channels[1].fadeDown( true );
}

MusicPlayer.prototype.swapChannel = function(){
	this.currentChannel = ( this.currentChannel !== this.channels[0] )?this.channels[0]:this.channels[1];
	this.status = this.currentChannel.audio.id;
	return this.currentChannel;
}

module.exports = MusicPlayer;
